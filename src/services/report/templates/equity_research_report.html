{% extends "base_report.html" %}

{% block title %}{{ (company.name or "—") }} ({{ (company.symbol or "—") }}) - Equity Research Report{% endblock %}

{% block report_title %}
  {% if company.logo_url %}<img src="{{ company.logo_url }}" alt="{{ company.name }} Logo" style="max-height: 80px; margin-bottom: 10px;">{% endif %}<br>
  {{ (company.name or "—") }} ({{ (company.symbol or "—") }})
{% endblock %}

{% block content %}

  {# ---------- helpers / fallbacks ---------- #}
  {% set dcf = dcf_valuation or {} %}
  {% set A = dcf.assumptions or {} %}
  {# WACC fallback: prefer enhanced key, else simple_dcf's discount_rate #}
  {% set wacc = (A.wacc if A.wacc is not none else A.discount_rate) %}
  {# Terminal growth fallback #}
  {% set g_terminal = (A.g_terminal if A.g_terminal is not none else A.terminal_growth) %}
  {# Stage1 growth fallback (or use simple revenue_growth) #}
  {% set g1 = (A.g1 if A.g1 is not none else A.revenue_growth) %}
  {# Stage2 growth may not exist in simple model #}
  {% set g2 = A.g2 %}
  {# Years mapping: enhanced vs simple projection_years #}
  {% set years_stage1 = (A.years_stage1 if A.years_stage1 is not none else A.projection_years) %}
  {% set years_stage2 = A.years_stage2 %}

  {# Chart source resolver: prefer inline data URIs in chart_srcs.*, else use CID for EML packaging #}
  {% set prof_src = (chart_srcs.profitability_chart if chart_srcs and chart_srcs.profitability_chart else 'cid:profitability_chart') %}
  {% set liq_src  = (chart_srcs.liquidity_chart     if chart_srcs and chart_srcs.liquidity_chart     else 'cid:liquidity_chart') %}
  {% set sens_src = (chart_srcs.dcf_sensitivity_chart if chart_srcs and chart_srcs.dcf_sensitivity_chart else 'cid:dcf_sensitivity_chart') %}
  {% set comps_src= (chart_srcs.comps_chart         if chart_srcs and chart_srcs.comps_chart         else 'cid:comps_chart') %}

  <!-- 1. Executive Summary -->
  <div class="section">
    <h2 class="section-title">1. Executive Summary</h2>

    {% if executive_summary %}
      <p>{{ executive_summary }}</p>
    {% else %}
      <p class="muted">No executive summary provided.</p>
    {% endif %}

    {% if investment_thesis %}
      <h4>Investment Thesis</h4>
      <p>{{ investment_thesis }}</p>
    {% endif %}

    {% if key_risks and key_risks|length > 0 %}
      <h4>Key Risks</h4>
      <ul>
        {% for risk in key_risks %}
          <li>
            {% if risk.title %}<strong>{{ risk.title }}:</strong> {% endif %}
            {{ risk.description or "-" }}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>

  <!-- 2. Financial Analysis -->
  <div class="section">
    <h2 class="section-title">2. Financial Analysis</h2>

    <!-- 2.1 Profitability -->
    {% if financial_summary and financial_summary.profitability %}
      <h3>2.1 Profitability</h3>
      <div class="chart">
        <img src="{{ prof_src }}" alt="Profitability Chart">
      </div>
      <table>
        <thead>
          <tr>
            <th>Metric</th>
            {% for period in (financial_summary.periods or []) %}
              <th>{{ period }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for metric, values in financial_summary.profitability.items() %}
            <tr>
              <td>{{ metric }}</td>
              {% for value in (values or []) %}
                <td>
                  {% if value is not none %}
                    {{ "%.2f"|format(value) }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="citation">Source: FMP, AI Equity Research Platform</p>
    {% endif %}

    <!-- 2.2 Liquidity & Solvency -->
    {% if financial_summary and financial_summary.liquidity %}
      <h3>2.2 Liquidity &amp; Solvency</h3>
      <div class="chart">
        <img src="{{ liq_src }}" alt="Liquidity Chart">
      </div>
      <table>
        <thead>
          <tr>
            <th>Metric</th>
            {% for period in (financial_summary.periods or []) %}
              <th>{{ period }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for metric, values in financial_summary.liquidity.items() %}
            <tr>
              <td>{{ metric }}</td>
              {% for value in (values or []) %}
                <td>
                  {% if value is not none %}
                    {{ "%.2f"|format(value) }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="citation">Source: FMP, AI Equity Research Platform</p>
    {% endif %}
  </div>

  <!-- 3. Valuation -->
  <div class="section">
    <h2 class="section-title">3. Valuation</h2>

    <!-- 3.1 Discounted Cash Flow (DCF) Analysis -->
    <h3>3.1 Discounted Cash Flow (DCF) Analysis</h3>
    <p>
      {% if dcf.fair_value_per_share is not none %}
        Our DCF analysis suggests a fair value of <strong>${{ dcf.fair_value_per_share|round(2) }}</strong> per share.
      {% else %}
        Our DCF analysis provides enterprise/equity value estimates; per-share fair value is unavailable.
      {% endif %}
    </p>

    <h4>Key Assumptions</h4>
    <ul>
      <li>WACC: {% if wacc is not none %}{{ (wacc * 100)|round(2) }}%{% else %}—{% endif %}</li>
      <li>Terminal Growth Rate: {% if g_terminal is not none %}{{ (g_terminal * 100)|round(2) }}%{% else %}—{% endif %}</li>
      <li>Stage 1 Growth{% if years_stage1 %} ({{ years_stage1 }} years){% endif %}: {% if g1 is not none %}{{ (g1 * 100)|round(2) }}%{% else %}—{% endif %}</li>
      <li>Stage 2 Growth{% if years_stage2 %} ({{ years_stage2 }} years){% endif %}: {% if g2 is not none %}{{ (g2 * 100)|round(2) }}%{% else %}—{% endif %}</li>
    </ul>

    {% if chart_srcs or dcf_sensitivity_chart %}
      <div class="chart">
        <img src="{{ sens_src }}" alt="DCF Sensitivity Analysis">
      </div>
      <p class="citation">Source: AI Equity Research Platform</p>
    {% endif %}

    <!-- 3.2 Comparable Company Analysis -->
    {% set comps = comparable_analysis or comps or {} %}
    {% if comps.peers and comps.peers|length > 0 %}
      <h3>3.2 Comparable Company Analysis</h3>
      <div class="chart">
        <img src="{{ comps_src }}" alt="Comparable Company Analysis">
      </div>
      <table>
        <thead>
          <tr>
            <th>Company</th>
            <th>P/E</th>
            <th>P/S</th>
            <th>EV/EBITDA</th>
          </tr>
        </thead>
        <tbody>
          {% for comp in comps.peers %}
            {% set sym = comp.symbol if comp.symbol is not none else comp.ticker %}
            <tr>
              <td>{{ sym or "—" }}</td>
              <td>{% if comp.pe is not none %}{{ "%.2f"|format(comp.pe) }}{% else %}—{% endif %}</td>
              <td>{% if comp.ps is not none %}{{ "%.2f"|format(comp.ps) }}{% else %}—{% endif %}</td>
              <td>{% if comp.ev_ebitda is not none %}{{ "%.2f"|format(comp.ev_ebitda) }}{% else %}—{% endif %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="citation">Source: FMP, AI Equity Research Platform</p>
    {% endif %}
  </div>

  <!-- 4. Risk Analysis -->
  {% if detailed_risks and detailed_risks|length > 0 %}
    <div class="section">
      <h2 class="section-title">4. Risk Analysis</h2>
      {% for risk in detailed_risks %}
        <h4>{{ risk.title or "Risk" }}</h4>
        <p>{{ risk.description or "—" }}</p>
        {% if risk.mitigation %}
          <p><strong>Mitigating Factors:</strong> {{ risk.mitigation }}</p>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

{% endblock %}
