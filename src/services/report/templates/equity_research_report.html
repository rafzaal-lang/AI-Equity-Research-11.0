{% extends "base_report.html" %}

{% block title %}{{ company.name }} ({{ company.symbol }}) - Equity Research Report{% endblock %}

{% macro fmt_num(v, d=2) -%}
  {%- if v is not none -%}{{ ("%%.%df"|format(d))|format(v) }}{%- else -%}N/A{%- endif -%}
{%- endmacro %}

{% macro fmt_pct(v, d=2) -%}
  {%- if v is not none -%}{{ ("%%.%df"|format(d))|format(v * 100) }}%{%- else -%}N/A{%- endif -%}
{%- endmacro %}

{% macro fmt_money(v, d=0, sym='$') -%}
  {%- if v is not none -%}
    {# basic money formatting; leave scaling to upstream #}
    {{ sym }}{{ ("%%,.%df"|format(d))|format(v) }}
  {%- else -%}N/A{%- endif -%}
{%- endmacro %}

{% block report_title %}
  {% if company.logo_url %}
    <img src="{{ company.logo_url }}" alt="{{ company.name }} Logo" style="max-height: 80px; margin-bottom: 10px;"><br>
  {% endif %}
  {{ company.name }} ({{ company.symbol }})
  <div style="font-size:12px;color:#6b7280;margin-top:6px;">
    As of {{ as_of or "—" }} · Report ID: {{ report_id or "—" }} · v{{ report_version or "1.0" }}
  </div>
{% endblock %}

{% block content %}

  <!-- 1. Executive Summary -->
  <div class="section">
    <h2 class="section-title">1. Executive Summary</h2>
    <p>{{ executive_summary or "Summary unavailable." }}</p>

    <h4>Investment Thesis</h4>
    <p>{{ investment_thesis or "—" }}</p>

    <h4>Key Risks</h4>
    {% if key_risks %}
      <ul>
        {% for risk in key_risks %}
          <li><strong>{{ risk.title }}</strong>{% if risk.description %}: {{ risk.description }}{% endif %}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>—</p>
    {% endif %}
  </div>

  <!-- 2. Financial Analysis -->
  <div class="section">
    <h2 class="section-title">2. Financial Analysis</h2>

    <!-- 2.1 Profitability -->
    <h3>2.1 Profitability</h3>
    {% set has_profitability = financial_summary and financial_summary.profitability and financial_summary.periods %}
    {% if has_profitability %}
      <div class="chart">
        <img src="cid:profitability_chart" alt="Profitability Chart"
             onerror="this.style.display='none'">
      </div>
      <table>
        <tr>
          <th>Metric</th>
          {% for period in financial_summary.periods %}
            <th>{{ period }}</th>
          {% endfor %}
        </tr>
        {% for metric, values in financial_summary.profitability.items() %}
          <tr>
            <td>{{ metric }}</td>
            {% for value in values %}
              <td>{{ fmt_num(value, 2) }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>Profitability time-series not available.</p>
    {% endif %}
    <p class="citation">Source: FMP, AI Equity Research Platform</p>

    <!-- 2.2 Liquidity & Solvency -->
    <h3>2.2 Liquidity &amp; Solvency</h3>
    {% set has_liquidity = financial_summary and financial_summary.liquidity and financial_summary.periods %}
    {% if has_liquidity %}
      <div class="chart">
        <img src="cid:liquidity_chart" alt="Liquidity Chart"
             onerror="this.style.display='none'">
      </div>
      <table>
        <tr>
          <th>Metric</th>
          {% for period in financial_summary.periods %}
            <th>{{ period }}</th>
          {% endfor %}
        </tr>
        {% for metric, values in financial_summary.liquidity.items() %}
          <tr>
            <td>{{ metric }}</td>
            {% for value in values %}
              <td>{{ fmt_num(value, 2) }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>Liquidity &amp; solvency time-series not available.</p>
    {% endif %}
    <p class="citation">Source: FMP, AI Equity Research Platform</p>
  </div>

  <!-- 3. Valuation -->
  <div class="section">
    <h2 class="section-title">3. Valuation</h2>

    <!-- 3.1 DCF -->
    <h3>3.1 Discounted Cash Flow (DCF) Analysis</h3>
    <p>
      {% set fvps = dcf_valuation and dcf_valuation.fair_value_per_share %}
      {% if fvps is not none %}
        Our DCF analysis suggests a fair value of <strong>${{ fmt_num(fvps, 2) }}</strong> per share.
      {% else %}
        Our DCF analysis did not produce a reliable per-share estimate. Summary assumptions below.
      {% endif %}
    </p>

    {% set ass = dcf_valuation.assumptions if dcf_valuation else {} %}
    <h4>Key Assumptions</h4>
    <ul>
      <li>WACC: {{ fmt_pct(ass.wacc, 2) }}</li>
      <li>Terminal Growth Rate: {{ fmt_pct(ass.g_terminal, 2) }}</li>
      <li>Stage 1 Growth ({{ ass.years_stage1 or "—" }} years): {{ fmt_pct(ass.g1, 2) }}</li>
      <li>Stage 2 Growth ({{ ass.years_stage2 or "—" }} years): {{ fmt_pct(ass.g2, 2) }}</li>
    </ul>

    {% set val = financial_summary.valuation if financial_summary else {} %}
    {% if val and (val.ev is not none or val.equity is not none) %}
      <p>
        <em>Valuation bridge:</em>
        {% if val.ev is not none %} EV {{ fmt_money(val.ev, 0, '$') }}{% endif %}
        {% if val.equity is not none %} · Equity {{ fmt_money(val.equity, 0, '$') }}{% endif %}
      </p>
    {% endif %}

    {% set sens = val.sensitivity if val else {} %}
    {% if sens and sens.z %}
      <div class="chart">
        <img src="cid:dcf_sensitivity_chart" alt="DCF Sensitivity Analysis"
             onerror="this.style.display='none'">
      </div>
      <p class="citation">Source: AI Equity Research Platform</p>
    {% else %}
      <p class="citation">Sensitivity grid unavailable.</p>
    {% endif %}

    <!-- 3.2 Comparable Company Analysis -->
    <h3>3.2 Comparable Company Analysis</h3>
    {% set comps = comparable_analysis or {} %}
    {% set peers = comps.peers or [] %}
    {% if peers %}
      <div class="chart">
        <img src="cid:comps_chart" alt="Comparable Company Analysis"
             onerror="this.style.display='none'">
      </div>
      <table>
        <tr>
          <th>Company</th>
          <th>P/E</th>
          <th>P/S</th>
          <th>EV/EBITDA</th>
        </tr>
        {% for comp in peers %}
          <tr>
            <td>{{ comp.symbol }}</td>
            <td>{{ fmt_num(comp.pe, 2) }}</td>
            <td>{{ fmt_num(comp.ps, 2) }}</td>
            <td>{{ fmt_num(comp.ev_ebitda, 2) }}</td>
          </tr>
        {% endfor %}
      </table>
      <p class="citation">Source: FMP, AI Equity Research Platform</p>
    {% else %}
      <p>No comparable companies available.</p>
    {% endif %}
  </div>

  <!-- 4. Risk Analysis -->
  <div class="section">
    <h2 class="section-title">4. Risk Analysis</h2>
    {% if detailed_risks %}
      {% for risk in detailed_risks %}
        <h4>{{ risk.title }}</h4>
        <p>{{ risk.description or "—" }}</p>
        {% if risk.mitigation %}<p><strong>Mitigating Factors:</strong> {{ risk.mitigation }}</p>{% endif %}
      {% endfor %}
    {% else %}
      <p>—</p>
    {% endif %}
  </div>

  {% if generation_date %}
    <div style="margin-top:24px;font-size:12px;color:#6b7280;">
      Generated {{ generation_date }}
    </div>
  {% endif %}

{% endblock %}
